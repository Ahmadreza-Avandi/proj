FROM python:3.7-slim

WORKDIR /app

# نصب فقط وابستگی‌های اصلی با نسخه‌های دقیق سازگار
RUN pip install --no-cache-dir markupsafe==2.0.1
RUN pip install --no-cache-dir jinja2==2.11.3
RUN pip install --no-cache-dir flask==1.1.4 werkzeug==1.0.1 
RUN pip install --no-cache-dir redis==4.1.0
RUN pip install --no-cache-dir requests==2.26.0 pillow==8.3.2

# ایجاد یک فایل server.py ساده‌تر
RUN echo 'from flask import Flask\nimport os\n\napp = Flask(__name__)\n\n@app.route("/")\ndef home():\n    return {"status": "ok", "service": "face-detection"}\n\n@app.route("/health")\ndef health():\n    return {"status": "healthy"}\n\nif __name__ == "__main__":\n    app.run(host="0.0.0.0", port=5000)' > server.py

# اطمینان از صحت اجرا
RUN python -c "from flask import Flask; app = Flask(__name__); print('Flask works!')"

# باز کردن پورت
EXPOSE 5000

# اجرای سرور ساده
CMD ["python", "server.py"] 